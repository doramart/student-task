"use strict";(self["webpackChunk_student_task_client"]=self["webpackChunk_student_task_client"]||[]).push([[62],{5062:function(t,r,e){e.r(r),e.d(r,{default:function(){return l}});var o=function(){var t=this,r=t._self._c;return r("div",{staticClass:"chatbot"},[r("div",{staticClass:"fixed-header"},[r("van-nav-bar",{attrs:{title:"AI助手","left-arrow":""},on:{"click-left":t.onBack},scopedSlots:t._u([{key:"right",fn:function(){return[r("van-icon",{attrs:{name:"home-o"},on:{click:t.goHome}})]},proxy:!0}])})],1),r("div",{staticClass:"main-content"},[t.isLoading?r("div",{staticClass:"loading-container"},[r("van-loading",{attrs:{size:"24px",vertical:""}},[t._v("AI助手加载中...")])],1):t._e(),r("iframe",{ref:"chatbotFrame",staticClass:"messages-container",class:{hidden:t.isLoading},attrs:{src:t.chatbotUrl,frameborder:"0",title:"AI助手"},on:{load:t.onIframeLoad,error:t.onIframeError}}),t.hasError?r("div",{staticClass:"error-container"},[r("van-empty",{attrs:{image:"error",description:"加载失败，请检查网络连接"}},[r("van-button",{staticClass:"bottom-button",attrs:{round:"",type:"primary"},on:{click:t.retryLoad}},[t._v(" 重新加载 ")])],1)],1):t._e()])])},a=[],s=(e(5639),e(9454),e(8092),e(400),e(1174),e(1406)),n={name:"Chatbot",data(){return{baseChatbotUrl:"https://micoai.cn:33081/chatbot/U1Y1I207JDSiDn5m",chatbotUrlWithToken:null,isLoading:!0,hasError:!1}},computed:{...(0,s.aH)(["token"]),chatbotUrl(){return this.chatbotUrlWithToken||this.baseChatbotUrl}},watch:{async token(t){void 0!==t&&(await this.buildChatbotUrl(),this.$refs.chatbotFrame&&this.retryLoad())}},async mounted(){this.$refs.chatbotFrame?.addEventListener("load",this.onIframeLoad),this.$refs.chatbotFrame?.addEventListener("error",this.onIframeError),await this.buildChatbotUrl()},beforeDestroy(){this.$refs.chatbotFrame?.removeEventListener("load",this.onIframeLoad),this.$refs.chatbotFrame?.removeEventListener("error",this.onIframeError)},methods:{async encodeAndCompress(t){try{const r=new TextEncoder,e=r.encode(t),o=new Response(e).body.pipeThrough(new CompressionStream("gzip")),a=await new Response(o).arrayBuffer(),s=new Uint8Array(a),n=Array.from(s).map(t=>String.fromCharCode(t)).join(""),i=btoa(n);return i}catch(r){return console.error("编码失败:",r),null}},async buildChatbotUrl(){try{if(this.token){const t=await this.encodeAndCompress(this.token);if(t){const r=new URL(this.baseChatbotUrl);r.searchParams.set("sys.user_id",t),this.chatbotUrlWithToken=r.toString(),console.log("构建聊天机器人URL成功")}else console.warn("Token编码失败，使用原始URL"),this.chatbotUrlWithToken=null}else console.warn("用户未登录，使用原始URL"),this.chatbotUrlWithToken=null}catch(t){console.error("构建聊天机器人URL失败:",t),this.chatbotUrlWithToken=null}},onBack(){this.$router.go(-1)},goHome(){this.$router.push("/tasks")},onIframeLoad(){this.isLoading=!1,this.hasError=!1,console.log("Chatbot iframe loaded successfully")},onIframeError(){this.isLoading=!1,this.hasError=!0,console.error("Failed to load chatbot iframe")},retryLoad(){this.isLoading=!0,this.hasError=!1,this.$refs.chatbotFrame&&(this.$refs.chatbotFrame.src=this.chatbotUrl)}}},i=n,h=e(5229),c=(0,h.A)(i,o,a,!1,null,"0e9e4ade",null),l=c.exports}}]);